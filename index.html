<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ì£¼ì¼í•™êµ ì¶œì„ë¶€</title>
    <link rel="stylesheet" as="style" crossorigin href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard@v1.3.9/dist/web/static/pretendard.min.css" />
    <style>
        :root { --primary: #4a90e2; --bg: #f0f2f5; --card: #ffffff; }
        body { font-family: 'Pretendard', sans-serif; margin: 0; padding: 20px 15px; background: var(--bg); }
        .main-container { max-width: 600px; margin: 0 auto; }
        .header-card { background: var(--card); padding: 20px; border-radius: 16px; box-shadow: 0 4px 12px rgba(0,0,0,0.05); margin-bottom: 20px; text-align: center; }
        .styled-input { width: 100%; padding: 12px; font-size: 1rem; border: 2px solid #ddd; border-radius: 12px; box-sizing: border-box; font-weight: 600; margin-bottom: 10px; }
        .table-container { background: var(--card); border-radius: 16px; overflow: hidden; box-shadow: 0 4px 12px rgba(0,0,0,0.05); border: 1px solid #ddd; }
        table { width: 100%; border-collapse: collapse; table-layout: fixed; }
        th { background: #f8f9fa; padding: 12px 2px; font-size: 0.8rem; border-bottom: 2px solid #ddd; }
        td { padding: 10px 2px; border-bottom: 1px solid #eee; text-align: center; font-size: 0.9rem; }
        input[type="checkbox"] { width: 22px; height: 22px; cursor: pointer; accent-color: var(--primary); }
        #status { position: fixed; bottom: 30px; left: 50%; transform: translateX(-50%); background: rgba(0,0,0,0.8); color: #fff; padding: 10px 20px; border-radius: 30px; font-size: 13px; display: none; z-index: 1000; }
    </style>
</head>
<body>

<div id="status">ë¡œë”© ì¤‘...</div>

<div class="main-container">
    <div class="header-card">
        <h2 style="margin-top:0;">â›ª ì¶œì„ë¶€</h2>
        <input type="date" id="datePicker" class="styled-input" onchange="updateDate(this.value)">
        <select id="gradeFilter" class="styled-input" onchange="filterGrade()">
            <option value="all">ì „ì²´ í•™ë…„</option>
            <option value="1">1í•™ë…„</option><option value="2">2í•™ë…„</option>
            <option value="3">3í•™ë…„</option><option value="4">4í•™ë…„</option>
            <option value="5">5í•™ë…„</option><option value="6">6í•™ë…„</option>
        </select>
    </div>

    <div class="table-container">
        <table>
            <thead>
                <tr>
                    <th style="width:25%;">ì´ë¦„</th><th>ì¶œì„</th><th>ë¨¸ë¦¿</th><th>í—Œê¸ˆ</th><th>ì•”ì†¡</th><th>ì›”ì•”</th>
                </tr>
            </thead>
            <tbody id="studentList"></tbody>
        </table>
    </div>
</div>

<script>
const students = [
    { grade: "1", name: "ê¹€ì§€í˜¸" }, { grade: "1", name: "ì‹ ì±„ì€" },
    { grade: "2", name: "ê¹€ì„¸ì•„" }, { grade: "2", name: "ë°±ìœ¤ìš°" }, { grade: "2", name: "ì‹ ë¦¬í˜¸" }, { grade: "2", name: "ì´ê°€ì€" }, { grade: "2", name: "ì´ì˜ˆì•ˆ" }, { grade: "2", name: "ìµœë‹¤ì†”" },
    { grade: "3", name: "ê¹€ë¯¼ì°¬" }, { grade: "3", name: "ê¹€ìœ ì„±" }, { grade: "3", name: "ë°•ì§€í•œ" }, { grade: "3", name: "ë°°ë¯¼í•˜" }, { grade: "3", name: "ì´ìœ í˜„" }, { grade: "3", name: "ì£¼ì¸ì„±" },
    { grade: "4", name: "ê¹€ì‹œì•„" }, { grade: "4", name: "ê¹€ìœ ë‚˜" }, { grade: "4", name: "ì„ì •ìš°" }, { grade: "4", name: "ê¹€ë™í•˜" }, { grade: "4", name: "ë°•íƒœì˜¨" }, { grade: "4", name: "ìœ ì‹œì˜" }, { grade: "4", name: "ìµœì§€ì˜¨" },
    { grade: "5", name: "ë°•ì´í•œ" }, { grade: "5", name: "ì„ìŠ¹ì£¼" }, { grade: "5", name: "ì£¼í˜„ì„±" },
    { grade: "6", name: "ê¹€í•˜ì´" }, { grade: "6", name: "ê¹€ì„œìœ¤" }, { grade: "6", name: "ë°•ë„ì´" }, { grade: "6", name: "ì´í•˜ì˜" }, { grade: "6", name: "ì¥ì„ ìš°" }, { grade: "6", name: "ìµœì§€ìœ¨" }, { grade: "6", name: "ê¹€ê°€ì˜¨" }, { grade: "6", name: "ê¹€ë‹¤í˜„" }, { grade: "6", name: "ê¹€ë™í•˜" }, { grade: "6", name: "ê¹€ë™í›ˆ" }, { grade: "6", name: "ì„ì¬ìœ¨" }
];

const GAS_URL = "https://script.google.com/macros/s/AKfycbzmDygQhf2ezvCQ1tHE0ggw_B2GOtbuKVRoPbt_3u4fx5TZt4BRkx7tLdN9wEiC7yfQVA/exec"; 
let targetDate = "";

// âœ… ë°ì´í„° ë¶ˆëŸ¬ì˜¤ê¸°
async function loadData() {
    showStatus("ğŸ” ë°ì´í„°ë¥¼ ê°€ì ¸ì˜¤ëŠ” ì¤‘...");
    try {
        const res = await fetch(`${GAS_URL}?date=${targetDate}&t=${Date.now()}`);
        const saved = await res.json();
        
        // ì²´í¬ë°•ìŠ¤ ì´ˆê¸°í™”
        document.querySelectorAll('input[type="checkbox"]').forEach(c => c.checked = false);

        saved.forEach(item => {
            // í•™ë…„ê³¼ ì´ë¦„ì„ ëª¨ë‘ ë¹„êµí•˜ì—¬ ì •í™•í•œ í–‰ ì°¾ê¸°
            const tr = document.querySelector(`tr[data-name="${item.name}"][data-grade="${String(item.grade)}"]`);
            if (tr) {
                tr.querySelector('[data-type="attendance"]').checked = item.attendance;
                tr.querySelector('[data-type="keystone"]').checked = item.keystone;
                tr.querySelector('[data-type="offering"]').checked = item.offering;
                tr.querySelector('[data-type="recitation"]').checked = item.recitation;
                tr.querySelector('[data-type="monthlyRecitation"]').checked = item.monthlyRecitation;
            }
        });
        showStatus("âœ… ë¡œë“œ ì™„ë£Œ", 1000);
    } catch (e) { showStatus("âŒ ë¡œë“œ ì‹¤íŒ¨", 2000); }
}

// âœ… ì‹¤ì‹œê°„ ì €ì¥
async function autoSave(name, grade) {
    showStatus("â˜ï¸ ì €ì¥ ì¤‘...");
    const tr = document.querySelector(`tr[data-name="${name}"][data-grade="${String(grade)}"]`);
    const payload = [{
        date: targetDate, name: name, grade: String(grade),
        attendance: tr.querySelector('[data-type="attendance"]').checked,
        keystone: tr.querySelector('[data-type="keystone"]').checked,
        offering: tr.querySelector('[data-type="offering"]').checked,
        recitation: tr.querySelector('[data-type="recitation"]').checked,
        monthlyRecitation: tr.querySelector('[data-type="monthlyRecitation"]').checked
    }];

    try {
        await fetch(GAS_URL, { method: "POST", mode: 'no-cors', body: JSON.stringify(payload) });
        showStatus("âœ… ì €ì¥ë¨", 1000);
    } catch (e) { showStatus("âš ï¸ ì˜¤ë¥˜ ë°œìƒ", 2000); }
}

function showStatus(m, d) {
    const s = document.getElementById('status');
    s.innerText = m; s.style.display = 'block';
    if(d) setTimeout(() => s.style.display = 'none', d);
}

function render(list) {
    document.getElementById('studentList').innerHTML = list.map(s => `
        <tr data-name="${s.name}" data-grade="${s.grade}">
            <td><b>${s.name}</b><br><small style="color:#999">${s.grade}í•™ë…„</small></td>
            <td><input type="checkbox" onchange="autoSave('${s.name}','${s.grade}')" data-type="attendance"></td>
            <td><input type="checkbox" onchange="autoSave('${s.name}','${s.grade}')" data-type="keystone"></td>
            <td><input type="checkbox" onchange="autoSave('${s.name}','${s.grade}')" data-type="offering"></td>
            <td><input type="checkbox" onchange="autoSave('${s.name}','${s.grade}')" data-type="recitation"></td>
            <td><input type="checkbox" onchange="autoSave('${s.name}','${s.grade}')" data-type="monthlyRecitation"></td>
        </tr>
    `).join('');
}

function updateDate(v) { targetDate = v; loadData(); }
function filterGrade() {
    const g = document.getElementById('gradeFilter').value;
    render(g === 'all' ? students : students.filter(s => s.grade === g));
    loadData();
}

window.onload = () => {
    const today = new Date();
    const sun = new Date(today.setDate(today.getDate() - today.getDay()));
    targetDate = sun.toISOString().split('T')[0];
    document.getElementById('datePicker').value = targetDate;
    render(students);
    loadData();
};
</script>
</body>
</html>
